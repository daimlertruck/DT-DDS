name: Build and Deploy Storybook

env:
  GIT_FAKE_EMAIL: dt-dds@daimlertruck.com
  GIT_FAKE_USER: dt-dds

on:
  push:
    branches:
      - main
    paths:
      - 'packages/dt-dds-react/**'
      - 'packages/react-packages/**'
      - 'apps/docs/**'
      - 'packages/themes'

  pull_request:
    paths:
      - 'packages/dt-dds-react/**'
      - 'packages/react-packages/**'
      - 'apps/docs/**'
      - 'packages/themes'

jobs:
  build-storybook:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
      cancel-in-progress: true
    if: ${{ !contains(github.event.head_commit.message, 'chore(release):') }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup node and yarn
        uses: './.github/actions/yarn-node-install'
        with:
          CACHE_FILE_NAME: 'global'

      - name: Build dependencies
        run: yarn run turbo build --filter='./packages/*'

      - name: Build Storybook
        run: |
          cd apps/docs
          yarn build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          path: './apps/docs/storybook-static'
          name: storybook-static

  deploy-storybook:
    needs: build-storybook
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup fake credentials
        run: |
          git config --global user.email ${{ env.GIT_FAKE_EMAIL }}
          git config --global user.name ${{ env.GIT_FAKE_USER }}

      - name: Create new branch
        run: |
          git checkout -b gh-pages-${{ github.run_number }} origin/gh-pages

      - name: Download Storybook files
        uses: actions/download-artifact@v4.1.7
        if: github.event_name == 'push'
        with:
          name: storybook-static
          path: ${{ github.workspace }}

      - name: Download Storybook files
        uses: actions/download-artifact@v4.1.7
        if: github.event_name == 'pull_request'
        with:
          name: storybook-static
          path: ${{ github.workspace }}/PR-${{ github.event.number }}

      # Not perfect, but should solve the issue.
      # See: https://github.com/storybookjs/storybook/issues/20564
      - name: Create .nojekyll file
        run: |
          touch .nojekyll

      - name: Deploy Storybook
        run: |
          git add . --all
          echo -e "\n\033[34m==>\033[0;1m" "Checking for Changes\033[0m"
          if [[ -z $(git status -s) ]]; then
            echo -e "\033[33;1m==>\033[0m" "No Changes found."
            exit 0
          else
            echo -e "\n\033[34m==>\033[0;1m" "Changes found.\033[0m"
            git commit -m "chore: update and publish Storybook"
            git checkout gh-pages
            git merge gh-pages-${{ github.run_number }}
            git push origin gh-pages
          fi

  change_pr_description:
    runs-on: ubuntu-latest
    needs: deploy-storybook
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check PR Description
        id: check_pr_description
        run: |
          # Get PR details using GitHub API
          PR_VIEW_OUTPUT=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.number }}" \
            | jq -r '.body // ""')

          PREVIEW_LINK="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/PR-${{ github.event.number }}"

          # Check if preview link already exists
          if echo "$PR_VIEW_OUTPUT" | grep -Fq "$PREVIEW_LINK"; then
            echo "Preview Link is already in the description."
            exit 0
          fi

          # Create new body with preview link
          NEW_BODY=$(jq -n --arg current "$PR_VIEW_OUTPUT" --arg link "$PREVIEW_LINK" '$current + "\n\n" + $link')
            
          # Update PR description
          curl -s \
            -X PATCH \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.number }}" \
            -d "{\"body\": $NEW_BODY}"

  delete_previews:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && !contains(github.event.head_commit.message, 'chore(release):')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup fake credentials
        run: |
          git config --global user.email ${{ env.GIT_FAKE_EMAIL }}
          git config --global user.name ${{ env.GIT_FAKE_USER }}

      - name: Find PR associated with commit
        id: find_pr
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const commitSha = context.sha;

            try {
              // Get PRs associated with this commit
              const { data: pulls } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: commitSha,
              });
              
              // Find the first closed PR
              const closedPR = pulls.find(pr => pr.state === 'closed');
              
              if (closedPR) {
                console.log(`Found closed PR #${closedPR.number} for commit ${commitSha}`);
                return closedPR.number.toString();
              } else {
                console.log(`No closed PR found for commit ${commitSha}`);
                return '';
              }
            } catch (error) {
              console.log(`Error finding PR for commit ${commitSha}:`, error.message);
              return '';
            }

      - name: Log if no PR found
        if: steps.find_pr.outputs.result == ''
        run: |
          echo "No closed PR found for commit ${{ github.sha }}. Skipping preview deletion."

      - name: Delete Preview Environment
        if: steps.find_pr.outputs.result != ''
        shell: bash
        run: |
          PR_NUMBER="${{ steps.find_pr.outputs.result }}"
          echo "Will delete preview environment for: PR-$PR_NUMBER"

          git checkout -b gh-pages-${{ github.run_number }} origin/gh-pages

          # Check if the PR preview directory exists before trying to delete
          if [ -d "PR-$PR_NUMBER" ]; then
            rm -rf PR-$PR_NUMBER
            git add . --all

            # Check if there are any changes to commit
            if [[ -n $(git status -s) ]]; then
              git commit -m "chore: delete PR preview for PR-$PR_NUMBER"
              git checkout gh-pages
              git merge gh-pages-${{ github.run_number }}
              git push origin gh-pages
            else
              echo "No changes to commit. Preview directory may have already been deleted."
              git checkout gh-pages
            fi
          else
            echo "Preview directory PR-$PR_NUMBER does not exist. Nothing to delete."
            git checkout gh-pages
          fi
