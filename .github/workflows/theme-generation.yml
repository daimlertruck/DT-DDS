name: Theme Generation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'packages/themes/src/tokens/**/*.json'
      - 'packages/themes/src/utils/theme-generator/**/*'
      - 'packages/themes/src/types/theme.ts'
      - 'packages/themes/package.json'

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: theme-generation-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  generate-themes:
    runs-on: ubuntu-latest
    name: Generate and commit themes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup node and yarn
        uses: './.github/actions/yarn-node-install'
        with:
          CACHE_FILE_NAME: 'global'

      - name: Format token files
        run: |
          echo "Formatting token files..."
          yarn format:tokens
          echo "Token files formatted successfully"
        working-directory: packages/themes

      - name: Generate themes
        id: generate
        run: |
          echo "Starting theme generation..."
          yarn build:theme
          echo "✅ Theme generation completed"
        working-directory: packages/themes
        continue-on-error: true

      - name: Update test snapshots
        if: steps.generate.outcome == 'success'
        run: |
          echo "Updating test snapshots..."
          yarn turbo run build --filter="@dt-dds/themes"
          yarn test:update
          echo "Snapshots updated"

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Generated theme files have changes"
            git status --porcelain
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes in generated theme files"
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.changes == 'true' && steps.generate.outcome == 'success'
        run: |
          echo "Current branch: $(git branch --show-current)"
          echo "Git status:"
          git status
          git config --local user.email "dt-dds@daimlertruck.com"
          git config --local user.name "dt-dds"
          git add packages/themes/src/themes/
          git add "**/__snapshots__/*.snap"
          git commit -m "feat: auto-generate themes from tokens

          This commit was automatically generated by 
          the theme generation workflow.

          Changes detected in token files:
          ${{ github.event.pull_request.title }}

          Generated theme files and test snapshots 
          have been updated to reflect the latest 
          token changes.

          Triggered by: ${{ github.event.pull_request.html_url }}"

      - name: Push changes
        if: steps.check-changes.outputs.changes == 'true' && steps.generate.outcome == 'success'
        run: |
          echo "Pushing to branch: ${{ github.head_ref }}"
          echo "Current branch: $(git branch --show-current)"
          git push origin HEAD:${{ github.head_ref }}

      - name: Comment on PR
        if: steps.generate.outcome == 'failure' && always()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ **Theme Generation Failed**
              
              The theme generation process encountered an error. Please check the workflow logs for details.
              
              This usually happens when:
              - Token files have syntax errors
              - Required tokens are missing
              - Theme validation fails
              
              Please review the token files and try again.`
            })

      - name: Comment on PR - Success
        if: steps.check-changes.outputs.changes == 'true' && steps.generate.outcome == 'success' && always()
        uses: actions/github-script@v7
        with:
          script: |
            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.body.includes('**Theme Generation Successful**'));

            const commentBody = `✅ **Theme Generation Successful**

            All themes and related tests have been updated.`;

            if (!botComment) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            } else {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            }

      - name: Final status check
        if: always()
        run: |
          echo "✅ Theme generation workflow completed"
          echo "Generate step outcome: ${{ steps.generate.outcome }}"
          echo "Check changes outcome: ${{ steps.check-changes.outcome }}"
          echo "Job status: ${{ job.status }}"
          echo "Workflow status: ${{ github.event_name }}"
